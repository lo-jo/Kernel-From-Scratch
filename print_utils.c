#include "kernel.h"

void ft_sardine(void)
{
	print_k(WHITE, " __      ___              _         \n", (char *)VIDEO, active_screen);
	print_k(WHITE, " \\ \\    / (_)            | |        \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "  \\ \\  / / ___   ____ _  | | __ _   \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "   \\ \\/ / | \\ \\ / / _` | | |/ _` |  \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "    \\  /  | |\\ V / (_| | | | (_| |  \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "     \\/   |_| \\_/ \\__,_| |_|\\__,_|  \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "                   | (_)            \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "  ___  __ _ _ __ __| |_ _ __   __ _ \n", (char *)VIDEO, active_screen);
	print_k(WHITE, " / __|/ _` | '__/ _` | | '_ \\ / _` |\n", (char *)VIDEO, active_screen);
	print_k(WHITE, " \\__ \\ (_| | | | (_| | | | | | (_| |\n", (char *)VIDEO, active_screen);
	print_k(WHITE, " |___/\\__,_|_|  \\__,_|_|_| |_|\\__,_|\n", (char *)VIDEO, active_screen);
	print_k(WHITE, "  | (_) |                           \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "  | |_| |__  _ __ ___     <*))))><  \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "  | | | '_ \\| '__/ _ \\        <*))))><\n", (char *)VIDEO, active_screen);
	print_k(WHITE, "  | | | |_) | | |  __/     <*))))><  \n", (char *)VIDEO, active_screen);
	print_k(WHITE, "  |_|_|_.__/|_|  \\___|             \n", (char *)VIDEO, active_screen);
}


// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⢀⣠⡤⠶⠒⠛⠋⢉⣉⣉⣉⣉⣉⣉⡉⠙⠛⠒⠶⢤⣄⡀⠀⠀⠀⠀
// ⠀⠀⣠⣾⠋⣁⣤⣶⣶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣶⣤⣈⠙⣷⣄⠀⠀
// ⠀⢸⣿⣧⡐⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢂⣼⣿⡇⠀
// ⠀⢀⠙⠿⣿⣦⣌⣉⣛⠛⠛⠛⠛⠻⠿⠿⠟⠛⠛⠛⠛⣛⣉⣡⣴⣿⠿⠋⡀⠀
// ⠀⢸⣷⣦⣄⣉⠙⠛⠻⠿⠿⢿⣶⣶⣶⣶⣶⣶⡿⠿⠿⠟⠛⠋⣉⣠⣴⣾⡇⠀
// ⠀⢸⣿⣿⣿⣿⣿⣿⣶⣶⣦⣤⣤⣤⣤⣤⣤⣤⣤⣴⣶⣶⣿⣿⣿⣿⣿⣿⡇⠀
// ⠀⢸⣿⣿⣿⡏⠻⣿⣿⣿⣿⣿⣿⡿⠿⠿⠿⠿⠿⠿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀
// ⠀⢸⣿⣿⣿⡇⠀⠀⠙⠛⠋⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠛⢿⣿⣿⣿⡇⠀
// ⠀⢸⣿⣿⣿⡇⠀⠀⣠⣶⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⣴⣾⣿⣿⣿⡇⠀
// ⠀⠀⠻⢿⣿⣇⣴⣿⣿⣿⣿⣿⣿⣿⣶⣶⣶⣶⣶⣶⣿⣿⣿⣿⣿⣿⡿⠟⠀⠀
// ⠀⠀⠀⠀⠉⠛⠻⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠿⠟⠛⠉⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀


                               

void putshell(int color, char c, char *screen)
{
	unsigned short *index;
	index = (unsigned short *)screen + SHELL_LINE * 80 + indexes[0].pos_x;

	if (c == '\b'){
		if (indexes[active_screen].pos_x != 0){
			if (indexes[active_screen].pos_x != 1){
				indexes[active_screen].pos_x--;
			}
			c = ' ';
			color = WHITE;
			*index = c | color << 8;
		}
	}
	else if (c < 0  && c > -10)
    	switch_screen((unsigned int)(-c - 1));
	else if (c == '\n'){
		// ADD FUNCTION TO PARSE INPUT
    exec_command((char *)VIDEO + (get_shell_index(0) * 2) - (command_len * 2) + 1);
    command_len = 0;
		clear_line(screen, SHELL_LINE);
		indexes[active_screen].pos_y++;
		indexes[active_screen].pos_x = 0;
		putshell(WHITE, '>', screen);
	}
	else{
    command_len++;
		*index = c | color << 8;
		indexes[active_screen].pos_x++;
	}
	if (indexes[active_screen].pos_x >= WIDTH){
		clear_line(screen, SHELL_LINE);
		indexes[active_screen].pos_x = 0;
		indexes[active_screen].pos_y++;
		putshell(WHITE, '>', screen);
	}
	if (indexes[active_screen].pos_y >= HEIGHT){
		scroll();
	}
	update_cursor();
}

void print_stack_test(void) {

  unsigned long *ebp;
  int frame = 0;

  trace_stack_test(ebp);
  while (ebp && ebp[0] && frame < 10)
  {
    print_k(WHITE, "Stack frame n ", (char *)VIDEO, active_screen);
    putkey(WHITE, frame + 48, (char *)VIDEO, active_screen);
    print_k(WHITE, ":   ", (char *)VIDEO, active_screen);
    putkey(WHITE, '\n', (char *)VIDEO, active_screen);
    print_k(WHITE, "ebp =", (char *)VIDEO, active_screen);
    print_hex((unsigned int)ebp, YELLOW);
    putkey(WHITE, '\n', (char *)VIDEO, active_screen);
    print_k(WHITE, "eip =", (char *)VIDEO, active_screen);
    print_hex(ebp[1], YELLOW);
    putkey(WHITE, '\n', (char *)VIDEO, active_screen);
    print_k(WHITE, "prev ebp =", (char *)VIDEO, active_screen);
    print_hex(ebp[0], YELLOW);
    putkey(WHITE, '\n', (char *)VIDEO, active_screen);
    putkey(WHITE, '\n', (char *)VIDEO, active_screen);
    ebp = (unsigned long *)ebp[0];
    frame++;
  }
  print_k(WHITE, "End of stack \n", (char *)VIDEO, active_screen);
  return ;
}

void print_hex(unsigned int value, int color){
	char *hex = "0123456789abcdef";
	char buffer[9];
	int i;

	buffer[8] = 0;
	for(i = 7; i >= 0; i--){
		buffer[i] = hex[value & 0xF];
		value >>= 4;
	}
	print_k(color, buffer, (char *)VIDEO, active_screen);
}

void putkey(int colour, char c, char *screen, unsigned int screen_nb){
	unsigned short *index;
	
	if (c == '\b'){
		if (indexes[screen_nb].pos_x != 0){
        	indexes[screen_nb].pos_x--;
		    index = (unsigned short *)screen + get_index(screen_nb);
          c = ' ';
          colour = WHITE;
		      *index = c | colour << 8;
		}
	}
  	else if (c < 0  && c > -10)
    	switch_screen((unsigned int)(-c - 1));
	else if (c == '\n'){
        indexes[screen_nb].pos_x = 0;
        indexes[screen_nb].pos_y++;
	}
	else{
		index = (unsigned short *)screen + get_index(screen_nb);
		*index = c | colour << 8;
		indexes[screen_nb].pos_x++;
	}
	if(indexes[screen_nb].pos_x >= 80)
    {
        indexes[screen_nb].pos_x = 0;
        indexes[screen_nb].pos_y++;
    }
    scroll();
	update_cursor();
}

// https://wiki.osdev.org/Printing_To_Screen
void print_k(int colour, const char *string, char *screen, unsigned int screen_nb){

    while(*string != 0 ){
        putkey(colour, *string++, screen, screen_nb);
    }
}


